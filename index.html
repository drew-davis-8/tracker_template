<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Worklog Dashboard â€” Standalone</title>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--text:#0f172a;--muted:#475569;--border:#e3e8ef;--accent:#2563eb}
    .hidden{display:none !important;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:1100px;margin:auto;padding:24px}
    h1{margin:0 0 10px 0;font-size:24px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
    input,textarea,select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font:inherit;background:#fff}
    textarea{resize:vertical}
    button{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}
    .primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    .kpi .value{font-weight:700;font-size:24px}
    .list{display:grid;gap:10px}
    .item{display:flex;justify-content:space-between;align-items:flex-start;gap:8px;border:1px solid var(--border);border-radius:12px;padding:10px;background:#fff}
    .tag{background:#eef2ff;border-radius:999px;padding:2px 8px;font-size:12px;margin-right:6px}
    .muted{color:var(--muted)}
    canvas{width:100%;max-width:100%;background:#fff;border:1px solid var(--border);border-radius:12px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#f1f5f9;border:1px solid var(--border);font-size:12px}
    .file-btn{position:relative; display:inline-block}
    .file-btn > input[type=file]{position:absolute; left:0; top:0; width:100%; height:100%; opacity:0; cursor:pointer}

    @media (max-width:900px){.kpis{grid-template-columns:repeat(2,minmax(0,1fr));}}

    .wl-tooltip{position:fixed;display:none;pointer-events:none;padding:6px 8px;border-radius:8px;background:#0f172a;color:#fff;font-size:12px;box-shadow:0 6px 20px rgba(0,0,0,.15);z-index:9999;white-space:nowrap}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h1>Daily Worklog & Follow-ups</h1>
      <div class="toolbar">
        <span id="cloudStatus" class="muted">Cloud: Not connected</span>
        <button id="connectCloud">Connect OneDrive File</button>
        <button id="syncNow" class="hidden">Sync now</button>
        <button id="disconnectCloud" class="hidden">Disconnect</button>
      </div>
    </div>

    <!-- Activity Entry -->
    <div class="row card" style="margin-top:8px">
      <div style="flex:1 1 160px">
        <label for="date">Date</label>
        <input id="date" type="date">
      </div>
      <div style="flex:3 1 260px">
        <label for="title">Title</label>
        <input id="title" placeholder="What did you work on?">
      </div>
      <div style="flex:1 1 160px">
        <label for="duration">Duration (minutes)</label>
        <input id="duration" type="number" min="0">
      </div>
      <div style="flex:1 1 200px">
        <label for="tags">Tags (comma separated)</label>
        <input id="tags" placeholder="access,security, etl">
      </div>
      <div style="flex:1 1 220px">
        <label for="details">Description</label>
        <textarea id="details" rows="2" placeholder="Add a short description..."></textarea>

        <label><input id="createFU" type="checkbox"> Create follow-up</label>
        <div id="fuBox" class="hidden" style="margin-top:6px;border:1px dashed var(--border);border-radius:10px;padding:8px">
          <input id="fuTitle" placeholder="Follow-up title (optional)" style="margin-bottom:6px">
          <label for="fuDue" style="margin-top:4px; display:block">Due date (optional)</label>
          <input id="fuDue" type="date" style="margin-bottom:6px">
          <label for="fuNotes" style="margin-top:4px; display:block">Follow-up notes (optional)</label>
          <textarea id="fuNotes" rows="3" placeholder="Additional context for this follow-up"></textarea>
        </div>
      </div>
      <div style="flex:1 1 100%;display:flex;justify-content:flex-end;gap:8px">
        <button id="add" class="primary">Add Activity</button>
        <button id="backup">Backup (JSON)</button>
        <span class="file-btn"><button id="restoreBtn" type="button">Restore (JSON)</button><input id="restore" type="file" accept="application/json"></span>
        <button id="exportCsv">Export CSV</button>
        <button id="reset">Reset</button>
      </div>
    </div>

    <!-- Charts -->
    <div class="row" style="gap:12px">
      <div class="card" style="flex:1 1 50%">
        <div class="muted">Hours by Day</div>
        <canvas id="byDay" height="260"></canvas>
      </div>
      <div class="card" style="flex:1 1 50%">
        <div class="muted">Hours by Tag</div>
        <canvas id="byTag" height="260"></canvas>
        <div id="legendByTag" class="row" style="margin-top:8px; flex-wrap:wrap; gap:6px"></div>
      </div>
    </div>

    <!-- (rest of your HTML: follow-ups, activities list, scripts, etc. remain unchanged) -->
    <!-- ... existing script code ... -->

    <script>
      // --- (your existing JS code remains unchanged except drawByTag + drawCumul) ---

      function drawByTag(acts){
        const c=$("byTag"), ctx=c.getContext("2d"), w=c.width=c.clientWidth*2, h=c.height=c.height*2/2;
        clearCanvas(c);

        let tip = document.getElementById("byTagTooltip");
        if(!tip){
          tip = document.createElement("div");
          tip.id = "byTagTooltip";
          tip.className = "wl-tooltip";
          document.body.appendChild(tip);
        }

        const legend = document.getElementById("legendByTag"); if (legend) legend.innerHTML="";
        const map={}; acts.forEach(a=>(a.tags||[]).forEach(t=>{ map[t]=(map[t]||0)+(a.durationMinutes||0); }));
        const entries=Object.entries(map).sort((a,b)=>b[1]-a[1]);
        const labels=entries.map(e=>e[0]);
        const values=entries.map(e=>Math.round((e[1]/60)*100)/100);
        const total = values.reduce((s,v)=>s+v,0) || 1;

        const cx=w/2, cy=h/2, r=Math.min(w,h)/2 - 20;
        let start=0;
        const slices=[];
        labels.forEach((lab,i)=>{
          const frac = values[i]/total; const end = start + frac*2*Math.PI;
          const hue = (i*70)%360;
          ctx.beginPath(); ctx.moveTo(cx,cy); ctx.fillStyle = `hsl(${hue},70%,70%)`;
          ctx.arc(cx,cy, r, start, end); ctx.closePath(); ctx.fill();
          slices.push({label: lab||"(untagged)", value: values[i], start, end, hue});
          start=end;
        });

        if(!c._tooltipInit){
          c.addEventListener("mousemove", (e)=>{
            if(!slices.length){ tip.style.display="none"; return; }
            const scale = c.width / c.clientWidth;
            const rect = c.getBoundingClientRect();
            const x = (e.clientX - rect.left) * scale;
            const y = (e.clientY - rect.top) * scale;
            const dx = x - cx, dy = y - cy;
            const dist = Math.sqrt(dx*dx + dy*dy);
            if (dist > r) { tip.style.display="none"; return; }
            let ang = Math.atan2(dy, dx); if (ang < 0) ang += Math.PI*2;
            const hit = slices.find(s => ang >= s.start && ang < s.end);
            if (!hit) { tip.style.display="none"; return; }
            tip.textContent = `${hit.label}: ${hit.value} h`;
            tip.style.left = (e.clientX + 12) + "px";
            tip.style.top = (e.clientY + 12) + "px";
            tip.style.display = "block";
          });
          c.addEventListener("mouseleave", ()=>{ tip.style.display="none"; });
          c._tooltipInit = true;
        }
      }

      function drawCumul(acts){
        const c=$("cumul");
        if(!c){ return; } // skip safely if no cumulative canvas
        const ctx=c.getContext("2d"), w=c.width=c.clientWidth*2, h=c.height=c.height*2/2;
        clearCanvas(c);
        // (rest unchanged)
      }
    </script>
  </div>
</body>
</html>
