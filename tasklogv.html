<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Daily Task Log</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f1220; --panel:#151a2b; --muted:#8b90a5; --text:#e8ebf7;
      --accent:#6aa9ff; --accent-2:#8ef0c6; --danger:#ff6b6b; --ok:#74d680;
      --chip:#1e2540; --border:#2a3252;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background:linear-gradient(180deg,#0b0e1a, #0f1220 30%, #0f1220);
      color:var(--text);
    }
    .wrap{max-width:920px; margin:24px auto; padding:0 16px 64px}
    header{display:flex; gap:16px; align-items:center; margin-bottom:16px}
    h1{font-size:22px; margin:0; letter-spacing:.2px}
    .badge{padding:4px 10px; border:1px solid var(--border); border-radius:999px; color:var(--muted)}
    .panel{background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:16px}
    .toolbar{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    label{font-size:12px; color:var(--muted)}
    input[type="date"], .text, .num, .btn, .file{
      background:#0d1120; border:1px solid var(--border); color:var(--text);
      border-radius:10px; padding:10px 12px; outline:none; font:inherit;
    }
    .text::placeholder{color:#667}
    .btn{cursor:pointer; border:1px solid var(--border)}
    .btn.primary{background:var(--accent); border:none; color:#0a1020; font-weight:600}
    .btn.ghost{background:transparent}
    .btn.danger{background:transparent; border-color:#3a2a2a; color:#ffb1b1}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    form.add{display:grid; grid-template-columns:2fr 1fr 100px 1fr 120px; gap:10px; margin-top:12px}
    @media (max-width:840px){ form.add{grid-template-columns:1fr 1fr 100px 1fr; } .notes-col{grid-column:1/-2} }
    @media (max-width:640px){ form.add{grid-template-columns:1fr; } }
    ul{list-style:none; margin:0; padding:0}
    .task{display:flex; align-items:center; gap:10px; padding:12px; border-bottom:1px solid var(--border)}
    .task:last-child{border-bottom:none}
    .task .title{flex:1; min-width:120px; line-height:1.3}
    .task .title[contenteditable="true"]{outline:none; border-bottom:1px dashed transparent}
    .task .title:focus{border-bottom-color:var(--accent)}
    .tags{display:flex; gap:6px; flex-wrap:wrap}
    .tag{background:var(--chip); color:#b9c3ff; border:1px solid var(--border); padding:2px 8px; border-radius:999px; font-size:12px; cursor:pointer}
    .right{display:flex; gap:8px; align-items:center}
    .mins{min-width:52px; text-align:right; font-variant-tabular-nums:tabular-nums}
    .stats{display:flex; gap:16px; flex-wrap:wrap; margin-top:8px; color:var(--muted)}
    .stat{padding:6px 10px; border:1px solid var(--border); border-radius:999px}
    .muted{color:var(--muted)}
    .strike{text-decoration:line-through; color:#9aa0b8}
    .small{font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Daily Task Log</h1>
      <span class="badge small">Local • Offline-first</span>
    </header>

    <div class="panel">
      <div class="toolbar">
        <div>
          <label for="day">Day</label><br />
          <input type="date" id="day" />
        </div>
        <div style="flex:1; min-width:220px">
          <label for="search">Search (title or tag)</label><br />
          <input class="text" id="search" placeholder="e.g., review PRs, #deep-work" />
        </div>
        <div>
          <label>&nbsp;</label><br />
          <label><input type="checkbox" id="hideDone" /> Hide completed</label>
        </div>
        <div style="margin-left:auto; display:flex; gap:8px; align-items:end; flex-wrap:wrap">
          <button class="btn ghost" id="exportBtn" title="Download JSON export">Export</button>
          <label class="btn ghost" for="importFile" title="Import JSON file" style="display:inline-flex; align-items:center; gap:6px; cursor:pointer">
            Import <input id="importFile" class="file" type="file" accept="application/json" hidden />
          </label>
        </div>
      </div>

      <form class="add" id="addForm" autocomplete="off">
        <input id="title" class="text" placeholder="Task title (required)" required />
        <input id="tags" class="text" placeholder="tags (comma‑separated)" />
        <input id="minutes" class="num" type="number" inputmode="numeric" min="0" step="5" placeholder="minutes" />
        <input id="notes" class="text notes-col" placeholder="notes (optional)" />
        <button class="btn primary" type="submit">Add</button>
      </form>

      <div class="stats" id="stats"></div>
    </div>

    <div class="panel" style="margin-top:16px">
      <ul id="list"></ul>
      <div id="empty" class="muted" style="padding:12px; display:none">No tasks for this day yet.</div>
    </div>
  </div>

  <script>
    const KEY = 'daily_tasks_v1';

    /** ---------- Utilities ---------- */
    const todayYMD = () => {
      const d = new Date();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${d.getFullYear()}-${mm}-${dd}`;
    };
    const parseTags = s => (s || '')
      .split(',')
      .map(x => x.trim())
      .filter(Boolean)
      .slice(0, 10);
    const makeId = () => `${Date.now().toString(36)}${Math.random().toString(36).slice(2,8)}`;

    const load = () => {
      try { return JSON.parse(localStorage.getItem(KEY)) || []; }
      catch { return []; }
    };
    const save = data => localStorage.setItem(KEY, JSON.stringify(data));

    /** ---------- State ---------- */
    let entries = load(); // array of {id,date,title,tags[],minutes,completed,notes,createdAt,updatedAt}

    /** ---------- DOM ---------- */
    const dayEl = document.getElementById('day');
    const searchEl = document.getElementById('search');
    const hideDoneEl = document.getElementById('hideDone');
    const listEl = document.getElementById('list');
    const emptyEl = document.getElementById('empty');
    const statsEl = document.getElementById('stats');

    const addForm = document.getElementById('addForm');
    const titleEl = document.getElementById('title');
    const tagsEl = document.getElementById('tags');
    const minutesEl = document.getElementById('minutes');
    const notesEl = document.getElementById('notes');

    const exportBtn = document.getElementById('exportBtn');
    const importFile = document.getElementById('importFile');

    /** ---------- Rendering ---------- */
    function render(){
      const day = dayEl.value;
      const term = (searchEl.value || '').trim().toLowerCase();
      const hideDone = hideDoneEl.checked;

      let dayItems = entries.filter(e => e.date === day);

      if (term) {
        dayItems = dayItems.filter(e =>
          e.title.toLowerCase().includes(term) ||
          (e.tags || []).some(t => t.toLowerCase().includes(term)) ||
          (e.notes || '').toLowerCase().includes(term)
        );
      }
      if (hideDone) dayItems = dayItems.filter(e => !e.completed);

      // sort: incomplete first, then newest first
      dayItems.sort((a, b) => {
        if (a.completed !== b.completed) return a.completed - b.completed;
        return (b.createdAt || 0) - (a.createdAt || 0);
      });

      // stats
      const total = entries.filter(e => e.date === day).length;
      const done = entries.filter(e => e.date === day && e.completed).length;
      const minutes = entries.filter(e => e.date === day).reduce((sum, e) => sum + (Number(e.minutes) || 0), 0);

      statsEl.innerHTML = `
        <span class="stat">Tasks: <strong>${total}</strong></span>
        <span class="stat">Completed: <strong>${done}</strong></span>
        <span class="stat">Minutes logged: <strong>${minutes}</strong></span>
      `;

      listEl.innerHTML = '';
      emptyEl.style.display = dayItems.length ? 'none' : 'block';

      for (const e of dayItems) {
        const li = document.createElement('li');
        li.className = 'task';
        li.dataset.id = e.id;

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = !!e.completed;
        cb.addEventListener('change', () => {
          e.completed = cb.checked;
          e.updatedAt = Date.now();
          save(entries); render();
        });

        const title = document.createElement('div');
        title.className = 'title' + (e.completed ? ' strike' : '');
        title.textContent = e.title;
        title.contentEditable = 'true';
        title.title = e.notes ? `Notes: ${e.notes}` : '';
        title.addEventListener('keydown', ev => {
          if (ev.key === 'Enter') { ev.preventDefault(); title.blur(); }
        });
        title.addEventListener('blur', () => {
          const v = (title.textContent || '').trim();
          if (!v) { title.textContent = e.title; return; }
          e.title = v; e.updatedAt = Date.now(); save(entries);
          render(); // update strike state if needed
        });

        const tagWrap = document.createElement('div');
        tagWrap.className = 'tags';
        (e.tags || []).forEach(t => {
          const chip = document.createElement('span');
          chip.className = 'tag';
          chip.textContent = `#${t}`;
          chip.title = `Filter by #${t}`;
          chip.addEventListener('click', () => { searchEl.value = t; render(); });
          tagWrap.appendChild(chip);
        });

        const right = document.createElement('div');
        right.className = 'right';

        const minus5 = document.createElement('button');
        minus5.className = 'btn';
        minus5.type = 'button';
        minus5.textContent = '−5';
        minus5.title = 'Subtract 5 minutes';
        minus5.addEventListener('click', () => adjustMinutes(e.id, -5));

        const plus5 = document.createElement('button');
        plus5.className = 'btn';
        plus5.type = 'button';
        plus5.textContent = '+5';
        plus5.title = 'Add 5 minutes';
        plus5.addEventListener('click', () => adjustMinutes(e.id, +5));

        const plus25 = document.createElement('button');
        plus25.className = 'btn';
        plus25.type = 'button';
        plus25.textContent = '+25';
        plus25.title = 'Add 25 minutes (Pomodoro)';
        plus25.addEventListener('click', () => adjustMinutes(e.id, +25));

        const mins = document.createElement('div');
        mins.className = 'mins';
        mins.textContent = `${e.minutes || 0}m`;

        const editBtn = document.createElement('button');
        editBtn.className = 'btn';
        editBtn.type = 'button';
        editBtn.textContent = 'Edit';
        editBtn.title = 'Edit tags & notes';
        editBtn.addEventListener('click', () => editEntry(e.id));

        const delBtn = document.createElement('button');
        delBtn.className = 'btn danger';
        delBtn.type = 'button';
        delBtn.textContent = 'Delete';
        delBtn.addEventListener('click', () => delEntry(e.id));

        right.append(minus5, plus5, plus25, mins, editBtn, delBtn);
        li.append(cb, title, tagWrap, right);
        listEl.appendChild(li);
      }
    }

    /** ---------- Actions ---------- */
    function adjustMinutes(id, delta){
      const e = entries.find(x => x.id === id);
      if (!e) return;
      const v = Math.max(0, (Number(e.minutes) || 0) + delta);
      e.minutes = v; e.updatedAt = Date.now();
      save(entries); render();
    }

    function editEntry(id){
      const e = entries.find(x => x.id === id);
      if (!e) return;
      const newTags = window.prompt('Edit tags (comma-separated):', (e.tags || []).join(', '));
      if (newTags !== null) e.tags = parseTags(newTags);
      const newNotes = window.prompt('Edit notes:', e.notes || '');
      if (newNotes !== null) e.notes = newNotes.trim();
      e.updatedAt = Date.now();
      save(entries); render();
    }

    function delEntry(id){
      const e = entries.find(x => x.id === id);
      if (!e) return;
      if (!confirm(`Delete “${e.title}”? This cannot be undone.`)) return;
      entries = entries.filter(x => x.id !== id);
      save(entries); render();
    }

    /** ---------- Event wiring ---------- */
    addForm.addEventListener('submit', ev => {
      ev.preventDefault();
      const title = (titleEl.value || '').trim();
      if (!title) { titleEl.focus(); return; }
      const entry = {
        id: makeId(),
        date: dayEl.value,
        title,
        tags: parseTags(tagsEl.value),
        minutes: Math.max(0, Number(minutesEl.value || 0)),
        notes: (notesEl.value || '').trim(),
        completed: false,
        createdAt: Date.now(),
        updatedAt: Date.now(),
      };
      entries.push(entry);
      save(entries);
      addForm.reset();
      titleEl.focus();
      render();
    });

    dayEl.addEventListener('change', render);
    searchEl.addEventListener('input', render);
    hideDoneEl.addEventListener('change', render);

    exportBtn.addEventListener('click', () => {
      const payload = { version:1, exportedAt:new Date().toISOString(), entries };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `daily-task-log-${todayYMD()}.json`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });

    importFile.addEventListener('change', async () => {
      const file = importFile.files && importFile.files[0];
      if (!file) return;
      try{
        const text = await file.text();
        let data = JSON.parse(text);
        if (Array.isArray(data)) data = {entries:data}; // backward-compat
        const incoming = Array.isArray(data.entries) ? data.entries : [];
        // naive merge by id (skip duplicates)
        const existingIds = new Set(entries.map(e => e.id));
        for (const e of incoming) {
          if (!e || !e.id || existingIds.has(e.id)) continue;
          entries.push(e);
        }
        save(entries); render();
        alert(`Imported ${incoming.length} item(s). Duplicates (by id) were skipped.`);
      } catch(err){
        alert('Import failed: invalid file.');
      } finally {
        importFile.value = '';
      }
    });

    /** ---------- Init ---------- */
    dayEl.value = todayYMD();
    render();
  </script>
</body>
</html>
